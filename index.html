<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ€æˆ®å°–å¡”å¼å¡ç‰Œæ¸¸æˆ</title>
    <link rel="stylesheet" href="src/styles/combat-ui.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #app {
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- åŠ è½½ç•Œé¢ -->
        <div class="loading-screen" id="loading-screen">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <h2>åŠ è½½ä¸­...</h2>
                <div class="loading-progress">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
            </div>
        </div>

        <!-- ä¸»èœå• -->
        <div class="main-menu hidden" id="main-menu">
            <div class="menu-background"></div>
            <div class="menu-content">
                <h1>æ€æˆ®å°–å¡”</h1>
                <h2 style="color: #9ca3af; font-family: 'Cinzel', serif; margin-bottom: 40px; letter-spacing: 4px;">Card Game</h2>
                <div class="menu-buttons">
                    <button class="menu-btn" onclick="startNewGame()">
                        <span class="btn-icon">âš”ï¸</span>
                        <span class="btn-text">æ–°æ¸¸æˆ</span>
                    </button>
                    <button class="menu-btn secondary" onclick="showCharacterSelect()">
                        <span class="btn-icon">ğŸ‘¤</span>
                        <span class="btn-text">é€‰æ‹©è§’è‰²</span>
                    </button>
                    <button class="menu-btn secondary" onclick="loadGame()">
                        <span class="btn-icon">ğŸ’¾</span>
                        <span class="btn-text">ç»§ç»­æ¸¸æˆ</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- è§’è‰²é€‰æ‹©ç•Œé¢ -->
        <div class="character-select hidden" id="character-select-screen" style="position: fixed; inset: 0; background: var(--bg-deep, #0a0a0f); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100;">
            <h2 style="color: #e0e0e0; font-family: 'Cinzel', serif; margin-bottom: 40px; font-size: 32px;">é€‰æ‹©ä½ çš„è§’è‰²</h2>
            <div style="display: flex; gap: 30px;">
                <div class="character-card" onclick="selectCharacter('ironclad')" style="background: linear-gradient(135deg, #c94e4e 0%, #2d1b1b 100%); padding: 30px; border-radius: 12px; width: 200px; text-align: center; cursor: pointer; border: 2px solid rgba(255,255,255,0.1); transition: transform 0.2s, box-shadow 0.2s;">
                    <div style="font-size: 64px; margin-bottom: 15px;">âš”ï¸</div>
                    <h3 style="color: #fff; margin: 0 0 10px 0;">é“ç”²æ­¦å£«</h3>
                    <p style="color: rgba(255,255,255,0.7); margin: 0; font-size: 14px;">æ“…é•¿æ”»å‡»å’Œæ ¼æŒ¡</p>
                </div>
                <div class="character-card" onclick="selectCharacter('silent')" style="background: linear-gradient(135deg, #4ecdc4 0%, #1b2d2d 100%); padding: 30px; border-radius: 12px; width: 200px; text-align: center; cursor: pointer; border: 2px solid rgba(255,255,255,0.1); transition: transform 0.2s, box-shadow 0.2s;">
                    <div style="font-size: 64px; margin-bottom: 15px;">ğŸ—¡ï¸</div>
                    <h3 style="color: #fff; margin: 0 0 10px 0;">é™é»˜è€…</h3>
                    <p style="color: rgba(255,255,255,0.7); margin: 0; font-size: 14px;">æ“…é•¿è¿å‡»å’Œæ¯’ç´ </p>
                </div>
                <div class="character-card" onclick="selectCharacter('defect')" style="background: linear-gradient(135deg, #a855f7 0%, #2d1b4e 100%); padding: 30px; border-radius: 12px; width: 200px; text-align: center; cursor: pointer; border: 2px solid rgba(255,255,255,0.1); transition: transform 0.2s, box-shadow 0.2s;">
                    <div style="font-size: 64px; margin-bottom: 15px;">ğŸ”®</div>
                    <h3 style="color: #fff; margin: 0 0 10px 0;">ç¼ºé™·</h3>
                    <p style="color: rgba(255,255,255,0.7); margin: 0; font-size: 14px;">ä½¿ç”¨ orbs è¿›è¡Œæˆ˜æ–—</p>
                </div>
            </div>
            <button onclick="backToMainMenu()" style="margin-top: 40px; padding: 12px 30px; background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; cursor: pointer; font-size: 16px;">è¿”å›</button>
        </div>

        <!-- æˆ˜æ–—ç•Œé¢ -->
        <div class="combat-ui hidden" id="combat-screen">
            <div class="combat-bg"></div>

            <div class="combat-container">
                <!-- å·¦ä¾§ï¼šç©å®¶çŠ¶æ€ -->
                <div class="player-panel">
                    <div class="player-avatar-container">
                        <div class="player-avatar">ğŸ›¡ï¸</div>
                    </div>

                    <div class="status-bars">
                        <!-- ç”Ÿå‘½å€¼ -->
                        <div class="status-bar hp-bar">
                            <div class="status-bar-label hp-label">
                                <span>ç”Ÿå‘½å€¼</span>
                                <span class="bar-label-icon">â¤ï¸</span>
                            </div>
                            <div class="status-bar-track">
                                <div class="status-bar-fill hp-fill" style="width: 100%"></div>
                                <span class="status-bar-text" id="hp-text">80/80</span>
                            </div>
                        </div>

                        <!-- æ ¼æŒ¡ -->
                        <div class="status-bar">
                            <div class="status-bar-label block-label">
                                <span>æ ¼æŒ¡</span>
                                <span class="bar-label-icon">ğŸ›¡ï¸</span>
                            </div>
                            <div class="status-bar-track">
                                <div class="status-bar-fill block-fill" style="width: 0%"></div>
                                <span class="status-bar-text" id="block-text">0</span>
                            </div>
                        </div>

                        <!-- èƒ½é‡ -->
                        <div class="status-bar">
                            <div class="status-bar-label energy-label">
                                <span>èƒ½é‡</span>
                                <span class="bar-label-icon">âš¡</span>
                            </div>
                            <div class="status-bar-track">
                                <div class="status-bar-fill energy-fill" style="width: 100%"></div>
                                <span class="status-bar-text" id="energy-text">3/3</span>
                            </div>
                        </div>
                    </div>

                    <!-- çŠ¶æ€æ•ˆæœ -->
                    <div class="status-effects" id="player-status-effects">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- ä¸­å¤®ï¼šæˆ˜æ–—åŒºåŸŸ -->
                <div class="battle-area">
                    <div class="enemies-container" id="enemies-container">
                        <!-- åŠ¨æ€ç”Ÿæˆæ•Œäºº -->
                    </div>
                </div>

                <!-- å³ä¾§ï¼šä¿¡æ¯é¢æ¿ -->
                <div class="info-panel">
                    <div class="panel-title">é—ç‰©</div>
                    <div class="relics-list" id="relics-list">
                        <!-- åŠ¨æ€ç”Ÿæˆé—ç‰© -->
                    </div>

                    <div class="panel-title" style="margin-top: 24px;">æˆ˜æ–—ä¿¡æ¯</div>
                    <div class="combat-log" id="combat-log">
                        <!-- æˆ˜æ–—æ—¥å¿— -->
                    </div>
                </div>

                <!-- åº•éƒ¨ï¼šæ“ä½œæ  -->
                <div class="action-bar">
                    <button class="action-btn primary" onclick="endTurn()">ç»“æŸå›åˆ</button>
                    <button class="action-btn secondary" onclick="returnToMenu()">è¿”å›</button>
                </div>

                <!-- æ‰‹ç‰ŒåŒºåŸŸ -->
                <div class="hand-area">
                    <div class="hand-cards" id="hand-cards">
                        <!-- åŠ¨æ€ç”Ÿæˆæ‰‹ç‰Œ -->
                    </div>

                    <!-- ç‰Œå †ä¿¡æ¯ -->
                    <div class="deck-info">
                        <div class="deck-pile">
                            <span class="deck-pile-icon">ğŸ´</span>
                            <span class="deck-pile-count" id="draw-count">10</span>
                        </div>
                        <div class="deck-pile">
                            <span class="deck-pile-icon">ğŸ“œ</span>
                            <span class="deck-pile-count" id="discard-count">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { CombatSystem } from './src/core/CombatSystem.js';
        import { IntentSystem } from './src/core/IntentSystem.js';
        import { RelicManager } from './src/core/RelicManager.js';
        import { StatusEffects } from './src/core/StatusEffects.js';
        import { CharacterSystem } from './src/core/CharacterSystem.js';
        import { MapSystem } from './src/core/MapSystem.js';
        import { CardManager } from './src/core/CardManager.js';

        // æ¸¸æˆå…¨å±€çŠ¶æ€
        window.game = {
            combat: null,
            intent: null,
            relics: null,
            status: null,
            character: null,
            map: null,
            cards: null
        };

        // æ¨¡æ‹ŸåŠ è½½
        async function initGame() {
            const progressBar = document.getElementById('progress-bar');

            // åˆå§‹åŒ–å¡ç‰Œç³»ç»Ÿ
            progressBar.style.width = '10%';
            window.game.cards = new CardManager();
            await window.game.cards.loadCards();
            await window.game.cards.createStarterDeck();
            await sleep(200);

            // åˆå§‹åŒ–æˆ˜æ–—ç³»ç»Ÿï¼ˆä¼ å…¥ cardManagerï¼‰
            progressBar.style.width = '30%';
            window.game.combat = new CombatSystem(null, window.game.cards);
            await sleep(200);

            window.game.intent = new IntentSystem();
            progressBar.style.width = '50%';
            await sleep(200);

            window.game.relics = new RelicManager(window.game.combat);
            await window.game.relics.loadRelics();
            progressBar.style.width = '70%';
            await sleep(200);

            window.game.status = new StatusEffects();
            progressBar.style.width = '90%';
            await sleep(200);

            progressBar.style.width = '100%';
            await sleep(300);

            // éšè—åŠ è½½ç•Œé¢ï¼Œæ˜¾ç¤ºä¸»èœå•
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // æš´éœ²å…¨å±€å‡½æ•°
        window.startNewGame = function() {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('combat-screen').classList.remove('hidden');
            startCombat();
        };

        window.showCharacterSelect = function() {
            document.getElementById('main-menu').classList.add('hidden');
            const charScreen = document.getElementById('character-select-screen');
            charScreen.classList.remove('hidden');
            charScreen.style.display = 'flex';
        };

        window.selectCharacter = function(characterId) {
            // ä¿å­˜é€‰æ‹©çš„è§’è‰²
            window.game.selectedCharacter = characterId;
            console.log('é€‰æ‹©äº†è§’è‰²:', characterId);

            // éšè—è§’è‰²é€‰æ‹©ç•Œé¢ï¼Œå¼€å§‹æ¸¸æˆ
            document.getElementById('character-select-screen').style.display = 'none';
            document.getElementById('main-menu').classList.remove('hidden');
        };

        window.backToMainMenu = function() {
            document.getElementById('character-select-screen').style.display = 'none';
            document.getElementById('main-menu').classList.remove('hidden');
        };

        window.loadGame = function() {
            alert('å­˜æ¡£åŠŸèƒ½å¼€å‘ä¸­...');
        };

        window.returnToMenu = function() {
            document.getElementById('combat-screen').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
        };

        window.endTurn = function() {
            if (window.game.combat) {
                window.game.combat.endPlayerTurn();
                updateCombatUI();
            }
        };

        function startCombat() {
            // åˆ›å»ºæµ‹è¯•æ•Œäºº
            const enemy = {
                id: 'goblin_minion',
                name: 'å“¥å¸ƒæ—å°å…µ',
                hp: 20,
                maxHp: 20,
                block: 0,
                attack: 6,
                armor: 0,
                icon: 'ğŸ‘º'
            };

            // å¼€å§‹æˆ˜æ–—
            window.game.combat.startCombat(enemy);
            updateCombatUI();
        }

        function updateCombatUI() {
            const combatState = window.game.combat.combatState;
            if (!combatState) return;

            const player = combatState.player;
            const enemy = combatState.enemy;

            // æ›´æ–°ç©å®¶çŠ¶æ€
            document.querySelector('.hp-fill').style.width = `${(player.hp / player.maxHp) * 100}%`;
            document.getElementById('hp-text').textContent = `${player.hp}/${player.maxHp}`;
            document.getElementById('block-text').textContent = player.block || 0;
            document.getElementById('energy-text').textContent = `${player.energy}/${player.maxEnergy}`;

            // æ›´æ–°æ•Œäººï¼ˆå°†å•ä¸ªæ•ŒäººåŒ…è£…æˆæ•°ç»„ï¼‰
            const enemiesContainer = document.getElementById('enemies-container');
            const enemyIcon = enemy.icon || 'ğŸ‘º';
            const enemyIntent = enemy.intent || { type: 'attack', value: '?' };

            // ç”ŸæˆçŠ¶æ€æ•ˆæœHTML
            let statusEffectsHTML = '';
            if (enemy.statusEffects && enemy.statusEffects.length > 0) {
                statusEffectsHTML = '<div class="enemy-status-effects">';
                enemy.statusEffects.forEach(effect => {
                    const effectIcons = {
                        vulnerable: 'ğŸ¯',
                        weak: 'ğŸ’¨',
                        poison: 'â˜ ï¸',
                        burn: 'ğŸ”¥',
                        strength: 'ğŸ’ª',
                        dexterity: 'ğŸƒ'
                    };
                    statusEffectsHTML += `<span class="status-effect ${effect.type}" title="${effect.type} (${effect.value})">${effectIcons[effect.type] || 'âš¡'}${effect.duration}</span>`;
                });
                statusEffectsHTML += '</div>';
            }

            enemiesContainer.innerHTML = `
                <div class="enemy-card" data-enemy-id="${enemy.id}">
                    <div class="enemy-icon">${enemyIcon}</div>
                    <div class="enemy-name">${enemy.name}</div>
                    ${statusEffectsHTML}
                    <div class="enemy-hp-text">${enemy.hp}/${enemy.maxHp}</div>
                    <div class="enemy-intent ${enemyIntent.type}">
                        ${enemyIntent.type === 'attack' ? 'âš”ï¸' : enemyIntent.type === 'defend' ? 'ğŸ›¡ï¸' : 'âœ¨'} ${enemyIntent.value}
                    </div>
                </div>
            `;

            // æ›´æ–°æ‰‹ç‰Œ
            const hand = window.game.cards.hand;
            const handCards = document.getElementById('hand-cards');
            handCards.innerHTML = hand.map(card => `
                <div class="card ${card.upgraded ? 'upgraded' : ''}" data-card-id="${card.id}" onclick="playCard('${card.id}')">
                    <div class="card-cost">${card.cost}</div>
                    <div class="card-content">
                        <div class="card-icon">${card.icon || 'âš”ï¸'}</div>
                        <div class="card-name">${card.name}</div>
                        <div class="card-description">${card.description}</div>
                    </div>
                </div>
            `).join('');

            // æ›´æ–°é—ç‰©
            const relics = window.game.relics.getOwnedRelics();
            const relicsList = document.getElementById('relics-list');
            relicsList.innerHTML = relics.map(relic => `
                <div class="relic-item" title="${relic.description}">
                    <div class="relic-icon">${relic.icon}</div>
                    <div class="relic-info">
                        <div class="relic-name">${relic.name}</div>
                    </div>
                </div>
            `).join('');

            // æ›´æ–°ç‰Œå †æ•°é‡
            document.getElementById('draw-count').textContent = window.game.cards.drawPile.length;
            document.getElementById('discard-count').textContent = window.game.cards.discardPile.length;
        }

        // æ‰“å‡ºå¡ç‰Œå‡½æ•°
        window.playCard = function(cardId) {
            if (!window.game.combat.combatState) return;

            const combatState = window.game.combat.combatState;
            const player = combatState.player;
            const enemy = combatState.enemy;

            // ä»æ‰‹ç‰Œä¸­æ‰¾åˆ°è¿™å¼ å¡
            const card = window.game.cards.hand.find(c => c.id === cardId);
            if (!card) {
                console.error('å¡ç‰Œä¸å­˜åœ¨:', cardId);
                return;
            }

            // æ£€æŸ¥èƒ½é‡æ˜¯å¦è¶³å¤Ÿ
            if (player.energy < card.cost) {
                addCombatLog('èƒ½é‡ä¸è¶³ï¼');
                return;
            }

            // æ·»åŠ æˆ˜æ–—æ—¥å¿—å‡½æ•°
            function addCombatLog(message) {
                const combatLog = document.getElementById('combat-log');
                const logEntry = document.createElement('div');
                logEntry.style.cssText = 'padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 12px;';
                logEntry.textContent = `> ${message}`;
                combatLog.insertBefore(logEntry, combatLog.firstChild);
                // åªä¿ç•™æœ€è¿‘20æ¡æ—¥å¿—
                while (combatLog.children.length > 20) {
                    combatLog.removeChild(combatLog.lastChild);
                }
            }

            // è®¡ç®—æ˜“ä¼¤åŠ æˆçš„ä¼¤å®³
            function calculateDamage(baseDamage, target) {
                let damage = baseDamage;
                // æ£€æŸ¥ç›®æ ‡æ˜¯å¦æœ‰æ˜“ä¼¤çŠ¶æ€
                const vulnerableEffect = target.statusEffects?.find(e => e.type === 'vulnerable');
                if (vulnerableEffect) {
                    damage = Math.floor(damage * 1.5); // æ˜“ä¼¤å¢åŠ 50%ä¼¤å®³
                    addCombatLog(`æ˜“ä¼¤ç”Ÿæ•ˆï¼åŸºç¡€ä¼¤å®³ ${baseDamage} -> ${damage}`);
                }
                return damage;
            }

            // æ ¹æ®å¡ç‰Œç±»å‹æ‰§è¡Œæ•ˆæœ
            try {
                if (card.type === 'attack') {
                    // æ”»å‡»å¡
                    let baseDamage = card.effect?.value || 0;
                    let damage = calculateDamage(baseDamage, enemy);
                    enemy.hp = Math.max(0, enemy.hp - damage);
                    addCombatLog(`ä½ ä½¿ç”¨${card.name}ï¼Œé€ æˆ ${damage} ç‚¹ä¼¤å®³ï¼`);
                } else if (card.type === 'defense') {
                    // é˜²å¾¡å¡
                    let block = card.effect?.value || 0;
                    player.block += block;
                    addCombatLog(`ä½ ä½¿ç”¨${card.name}ï¼Œè·å¾— ${block} ç‚¹æ ¼æŒ¡ï¼`);
                } else if (card.type === 'skill') {
                    // æŠ€èƒ½å¡
                    const effect = card.effect;
                    if (effect.type === 'damage') {
                        let baseDamage = effect.value;
                        let damage = calculateDamage(baseDamage, enemy);
                        enemy.hp = Math.max(0, enemy.hp - damage);
                        addCombatLog(`ä½ ä½¿ç”¨${card.name}ï¼Œé€ æˆ ${damage} ç‚¹ä¼¤å®³ï¼`);
                    } else if (effect.type === 'draw') {
                        // æŠ½ç‰Œ
                        const drawn = window.game.cards.drawCards(effect.value);
                        addCombatLog(`ä½ ä½¿ç”¨${card.name}ï¼ŒæŠ½äº† ${drawn.length} å¼ ç‰Œï¼`);
                    } else if (effect.type === 'energy') {
                        player.energy = Math.min(player.maxEnergy, player.energy + effect.value);
                        addCombatLog(`ä½ ä½¿ç”¨${card.name}ï¼Œè·å¾— ${effect.value} ç‚¹èƒ½é‡ï¼`);
                    } else if (effect.type === 'vulnerable') {
                        // æ˜“ä¼¤æ•ˆæœ - ç»™æ•Œäººæ·»åŠ çŠ¶æ€
                        enemy.statusEffects.push({
                            type: 'vulnerable',
                            duration: effect.value || 1,
                            value: 0
                        });
                        addCombatLog(`ä½ ä½¿ç”¨${card.name}ï¼Œæ•Œäººè·å¾—æ˜“ä¼¤ï¼åç»­æ”»å‡»ä¼¤å®³å¢åŠ 50%`);
                    } else if (effect.type === 'draw_energy') {
                        // æŠ½ç‰Œ+èƒ½é‡
                        window.game.cards.drawCards(1);
                        player.energy = Math.min(player.maxEnergy, player.energy + effect.value);
                        addCombatLog(`ä½ ä½¿ç”¨${card.name}ï¼ŒæŠ½1å¼ ç‰Œï¼Œè·å¾—${effect.value}ç‚¹èƒ½é‡ï¼`);
                    }
                }

                // æ¶ˆè€—èƒ½é‡
                player.energy -= card.cost;

                // å°†å¡ç‰Œä»æ‰‹ç‰Œç§»åˆ°å¼ƒç‰Œå †
                const cardIndex = window.game.cards.hand.findIndex(c => c.id === cardId);
                if (cardIndex > -1) {
                    const [playedCard] = window.game.cards.hand.splice(cardIndex, 1);
                    window.game.cards.discardPile.push(playedCard);
                }

                // æ£€æŸ¥æ•Œäººæ˜¯å¦æ­»äº¡
                if (enemy.hp <= 0) {
                    enemy.hp = 0;
                    updateCombatUI();
                    addCombatLog(`æˆ˜æ–—èƒœåˆ©ï¼ä½ å‡»è´¥äº† ${enemy.name}ï¼`);
                    // æ˜¾ç¤ºæˆ˜æ–—èƒœåˆ©æ¶ˆæ¯
                    setTimeout(() => {
                        alert(`âš”ï¸ æˆ˜æ–—èƒœåˆ©ï¼\n\nä½ å‡»è´¥äº† ${enemy.name}ï¼`);
                        // è¿”å›ä¸»èœå•
                        document.getElementById('combat-screen').classList.add('hidden');
                        document.getElementById('main-menu').classList.remove('hidden');
                    }, 500);
                    return;
                }

                // æ£€æŸ¥ç©å®¶æ˜¯å¦æ­»äº¡
                if (player.hp <= 0) {
                    player.hp = 0;
                    updateCombatUI();
                    addCombatLog('æˆ˜æ–—å¤±è´¥ï¼ä½ è¢«å‡»è´¥äº†...');
                    setTimeout(() => {
                        alert('ğŸ’€ æˆ˜æ–—å¤±è´¥\n\nä½ è¢«å‡»è´¥äº†...');
                        // è¿”å›ä¸»èœå•
                        document.getElementById('combat-screen').classList.add('hidden');
                        document.getElementById('main-menu').classList.remove('hidden');
                    }, 500);
                    return;
                }

                // æ›´æ–°ç•Œé¢
                updateCombatUI();

            } catch (error) {
                console.error('å‡ºç‰Œé”™è¯¯:', error);
                addCombatLog(`å‡ºç‰Œé”™è¯¯: ${error.message}`);
            }
        };

        // åˆå§‹åŒ–æ¸¸æˆ
        initGame();
    </script>
</body>
</html>
